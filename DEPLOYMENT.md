# Deployment Guide - UW Erg Warrior Leaderboard

## Pre-Deployment Checklist

### 1. Update OAuth Redirect URIs

#### Discord OAuth App
Go to [Discord Developer Portal](https://discord.com/developers/applications)
1. Select your application
2. Go to OAuth2 → General → Redirects
3. Add your production URL: `https://your-app.vercel.app/api/auth/callback/discord`
4. Keep the localhost URL for local development
5. Save Changes

#### Concept2 OAuth App
Go to [Concept2 Logbook API](https://log.concept2.com/developers/keys)
1. Edit your application
2. Add production redirect URI: `https://your-app.vercel.app/auth/concept2/callback`
3. Keep the localhost URL for local development
4. Save

### 2. Get Your Production Database URL

If using Neon (recommended):
1. Go to [Neon Console](https://console.neon.tech/)
2. Create a new branch called `production` from your `main` branch
   - OR use your existing main database
3. Copy the connection string

## Deploy to Vercel

### Option A: Deploy via Vercel Dashboard (Recommended)

1. **Push to GitHub**
   ```bash
   git add .
   git commit -m "Add features: calories, gender, fat burned, dark mode, UWaterloo branding, Discord weekly summary"
   git push origin main
   ```

2. **Import to Vercel**
   - Go to [Vercel Dashboard](https://vercel.com/new)
   - Click "Import Project"
   - Select your GitHub repository
   - Click "Import"

3. **Configure Environment Variables**

   In Vercel Dashboard → Settings → Environment Variables, add:

   ```env
   # Discord OAuth (Production)
   DISCORD_CLIENT_ID=1465186912804536442
   DISCORD_CLIENT_SECRET=3tOeCivhHrkGtnuzyp0dUgelo9SsQtkI
   DISCORD_SERVER_ID=1045798370746302594

   # Concept2 OAuth
   CONCEPT2_CLIENT_ID=oo0IKfRbbdYfUgfdXDBi6L8vKqIJP584EgVJqC6Z
   CONCEPT2_CLIENT_SECRET=wePUcIB5HcWDOJ1tr5lg8xeyuEPfwVUgZ1PrDHlq
   CONCEPT2_REDIRECT_URI=https://your-app.vercel.app/auth/concept2/callback

   # NextAuth
   NEXTAUTH_URL=https://your-app.vercel.app
   NEXTAUTH_SECRET=YOUR_RANDOM_SECRET_HERE

   # Database (Production PostgreSQL)
   DATABASE_URL=postgresql://user:password@host/database

   # App Configuration
   NEXT_PUBLIC_APP_NAME=UW Erg Warrior Leaderboard
   NEXT_PUBLIC_APP_URL=https://your-app.vercel.app

   # Discord Webhook for Weekly Summary
   DISCORD_WEBHOOK_URL=https://discordapp.com/api/webhooks/1466246026498277590/gFtN4rb3HK-Sm8AQQ4p1biqXMGVZg0Y6ZnxgjLEOuo44iQmgVzpqY98CKq5EvgCYN2HU
   WEBHOOK_SECRET=test-secret-123

   # Vercel Cron Secret (auto-generated by Vercel for cron jobs)
   CRON_SECRET=
   ```

   **IMPORTANT**: Generate a new `NEXTAUTH_SECRET` for production:
   ```bash
   openssl rand -base64 32
   ```

4. **Deploy**
   - Click "Deploy"
   - Wait for deployment to complete
   - Vercel will give you a URL like: `https://your-app.vercel.app`

5. **Update Environment Variables with Production URL**
   - Go back to Environment Variables
   - Update `NEXTAUTH_URL` with your actual Vercel URL
   - Update `CONCEPT2_REDIRECT_URI` with your actual Vercel URL
   - Update `NEXT_PUBLIC_APP_URL` with your actual Vercel URL
   - Redeploy (Vercel → Deployments → Click "..." → Redeploy)

6. **Update OAuth Redirect URIs**
   - Go back to Discord and Concept2 apps
   - Update the redirect URIs with your actual Vercel URL
   - Save changes

### Option B: Deploy via Vercel CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Login to Vercel
vercel login

# Deploy
vercel

# Follow prompts and it will deploy
```

## Post-Deployment

### 1. Test the App
1. Visit your production URL
2. Sign in with Discord
3. Link Concept2 account
4. Check leaderboard displays correctly
5. Test dark mode toggle

### 2. Test Discord Weekly Summary
Visit: `https://your-app.vercel.app/api/discord/weekly-summary?token=test-secret-123`

This should send a test message to your Discord channel.

### 3. Verify Cron Job
The weekly summary will automatically run every Sunday at 12:00 PM (noon).

You can check cron job logs in:
- Vercel Dashboard → Your Project → Cron Jobs

## Automated Weekly Summary

The app is configured to send a weekly leaderboard summary to Discord every Sunday at 12:00 PM.

**Schedule (configured in `vercel.json`):**
```json
{
  "crons": [
    {
      "path": "/api/discord/weekly-summary",
      "schedule": "0 12 * * 0"
    }
  ]
}
```

**To change the schedule**, edit `vercel.json`:
- `"0 12 * * 0"` = Every Sunday at 12:00 PM (noon)
- `"0 9 * * 1"` = Every Monday at 9:00 AM
- `"0 17 * * 5"` = Every Friday at 5:00 PM

After changing, commit and push to trigger a new deployment.

## Database Migrations (Production)

If you need to update the database schema in production:

```bash
# Make sure DATABASE_URL points to production
export DATABASE_URL="your-production-database-url"

# Push schema changes
npx prisma db push

# Or create a migration
npx prisma migrate deploy
```

## Troubleshooting

### "Configuration" Error
- Check that all environment variables are set in Vercel
- Especially `NEXTAUTH_SECRET` and `DATABASE_URL`

### OAuth Errors
- Verify redirect URIs match exactly in Discord/Concept2 apps
- Check that `NEXTAUTH_URL` matches your actual domain

### Database Errors
- Ensure `DATABASE_URL` is correct and accessible from Vercel
- Check that database schema is up to date

### Cron Job Not Running
- Check Vercel cron logs in dashboard
- Verify `WEBHOOK_SECRET` is set
- Test manually: `https://your-app.vercel.app/api/discord/weekly-summary?token=test-secret-123`

## Security Notes

- Never commit `.env.local` to git (it's in `.gitignore`)
- Use different secrets for production vs development
- Keep Discord webhook URL private
- Rotate secrets periodically

## Support

If you encounter issues:
1. Check Vercel deployment logs
2. Check browser console for errors
3. Verify all environment variables are set correctly
